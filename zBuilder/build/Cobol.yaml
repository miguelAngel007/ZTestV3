---
#
# Licensed materials - Property of IBM
# 5655-AC5 Copyright IBM Corp. 2024, 2025
# All rights reserved
# US Government users restricted rights  -  Use, duplication or
# disclosure restricted by GSA ADP schedule contract with IBM Corp.
#
####################################
# Cobol language configuration
# Using dynamic JCL lines for REGION=0M support
#################################### 

version: 1.0.3
tasks:
  # Cobol Language task
  - language: Cobol

    # source file association patterns
    sources:
      - "**/cobol/*.cbl"
      
    # overridable variables
    variables:
      # conditional variable builds compile parameters i.e CICS,SQL
      - name: compileParms
        value: LIB
        append:
          - condition: ${IS_CICS}
            value: CICS
          - condition: ${IS_SQL}
            value: SQL
          - condition: 
              exists: errPrefix
            value: ADATA,EX(ADX(ELAXMGUX))
          - condition: 
              exists: debug
              eval: ${debug}
            value: TEST

      # =====================================================
      # Dynamic JCL lines - STEPLIB additions
      # =====================================================
      - name: steplibCICS
        value: "//*"
        select:
          - condition: ${IS_CICS}
            value: "//         DD DSN=${SDFHLOAD},DISP=SHR"

      - name: steplibSQL
        value: "//*"
        select:
          - condition: ${IS_SQL}
            value: "//         DD DSN=${SDSNLOAD},DISP=SHR"

      # =====================================================
      # Dynamic JCL lines - SYSLIB additions
      # =====================================================
      - name: syslibCICS
        value: "//*"
        select:
          - condition: ${IS_CICS}
            value: "//         DD DSN=${SDFHCOB},DISP=SHR"

      - name: syslibMQ
        value: "//*"
        select:
          - condition: ${IS_MQ}
            value: "//         DD DSN=${SCSQCOBC},DISP=SHR"

      # =====================================================
      # Dynamic JCL lines - DBRMLIB (only for SQL)
      # =====================================================
      - name: dbrmlib
        value: "//*"
        select:
          - condition: ${IS_SQL}
            value: "//DBRMLIB  DD DSN=${HLQ}.DBRM(${MEMBER}),DISP=SHR"

      # =====================================================
      # Dynamic JCL lines - SFELLOAD (Fault Analyzer)
      # =====================================================
      - name: steplibFEL
        value: "//*"
        select:
          - condition:
              exists: SFELLOAD
            value: "//         DD DSN=${SFELLOAD},DISP=SHR"

      # =====================================================
      # Dynamic JCL lines - SYSADATA and SYSXMLSD (errPrefix)
      # =====================================================
      - name: sysadata
        value: "//*"
        select:
          - condition:
              exists: errPrefix
            value: "//SYSADATA DD DUMMY"

      - name: sysxmlsd
        value: "//*"
        select:
          - condition:
              exists: errPrefix
            value: "//SYSXMLSD DD DSN=${HLQ}.${errPrefix}.SYSXMLSD.XML,DISP=(NEW,KEEP),SPACE=(TRK,(200,40)),BLKSIZE=27998,LRECL=16383,RECFM=VB"
            
      # flag to perform linkedit
      - name: doLinkEdit
        value: true
        
      # default link edit parameters
      - name: linkEditParms
        value: MAP,RENT

      # build record output deploy type
      - name: deployType
        value: LOAD
        select:
          - condition: ${IS_CICS}
            value: CICSLOAD
          - condition: ${IS_DLI}
            value: IMSLOAD
          - condition: ${isIMS}
            value: IMSLOAD

      # flag to activate IMS options
      - name: isIMS
        value: false
        
      # default dependency search path for single repository build
      - name: dependencySearchPath
        value: search:${WORKSPACE}/?path=${APP_DIR_NAME}/copybook/*.cpy

      # flag indicating to scan the load module for static link dependencies  
      - name: scanLoadModule
        value: true
    
    # datasets that need to be created / validated for this language configuration
    datasets:
      - name: ${HLQ}.COBOL
        options: cyl space(1,1) lrecl(80) dsorg(PO) recfm(F,B) dsntype(library)
      - name: ${HLQ}.COPY
        options: cyl space(1,1) lrecl(80) dsorg(PO) recfm(F,B) dsntype(library)
      - name: ${HLQ}.BMS.COPY
        options: cyl space(1,1) lrecl(80) dsorg(PO) recfm(F,B) dsntype(library)
      - name: ${HLQ}.DBRM
        options: cyl space(1,1) lrecl(80) dsorg(PO) recfm(F,B) dsntype(library)
      - name: ${HLQ}.OBJ
        options: cyl space(1,1) lrecl(80) dsorg(PO) recfm(F,B) dsntype(library)
      - name: ${HLQ}.LOAD
        options: cyl space(1,1) dsorg(PO) recfm(U) blksize(32760) dsntype(library)

    # list of steps to execute for each program processed by this language configuration
    steps:
    
      # Copy build file and dependency files to data sets
      - step: copySrc
        type: copy
        target: //'${HLQ}.COBOL(${MEMBER})'
        dependencyCopy:
          - search: ${dependencySearchPath}
            mappings:
              - source: "**/*"
                dataset: ${HLQ}.COPY
                
      # COBOL compile step with REGION=0M using dynamic JCL
      - step: compile
        type: job
        maxRC: 4
        text: |
          //${MEMBER} JOB ,'COMPILE DBB',CLASS=${JOBCLASS},MSGCLASS=${MSGCLASS}
          //COMPILE  EXEC PGM=IGYCRCTL,REGION=${COMPREGION},PARM='${compileParms}'
          //STEPLIB  DD DSN=${SIGYCOMP},DISP=SHR
          //         DD DSN=${SCEERUN},DISP=SHR
          //         DD DSN=${SCEERUN2},DISP=SHR
          ${steplibCICS}
          ${steplibSQL}
          ${steplibFEL}
          //SYSIN    DD DSN=${HLQ}.COBOL(${MEMBER}),DISP=SHR
          //SYSLIN   DD DSN=${HLQ}.OBJ(${MEMBER}),DISP=SHR
          //SYSPRINT DD SYSOUT=*
          ${dbrmlib}
          //SYSMDECK DD UNIT=VIO,SPACE=(CYL,(5,5)),BLKSIZE=80,LRECL=80,RECFM=FB
          //SYSUT1   DD UNIT=VIO,SPACE=(CYL,(5,5)),BLKSIZE=80,LRECL=80,RECFM=FB
          //SYSUT2   DD UNIT=VIO,SPACE=(CYL,(5,5)),BLKSIZE=80,LRECL=80,RECFM=FB
          //SYSUT3   DD UNIT=VIO,SPACE=(CYL,(5,5)),BLKSIZE=80,LRECL=80,RECFM=FB
          //SYSUT4   DD UNIT=VIO,SPACE=(CYL,(5,5)),BLKSIZE=80,LRECL=80,RECFM=FB
          //SYSUT5   DD UNIT=VIO,SPACE=(CYL,(5,5)),BLKSIZE=80,LRECL=80,RECFM=FB
          //SYSUT6   DD UNIT=VIO,SPACE=(CYL,(5,5)),BLKSIZE=80,LRECL=80,RECFM=FB
          //SYSUT7   DD UNIT=VIO,SPACE=(CYL,(5,5)),BLKSIZE=80,LRECL=80,RECFM=FB
          //SYSUT8   DD UNIT=VIO,SPACE=(CYL,(5,5)),BLKSIZE=80,LRECL=80,RECFM=FB
          //SYSUT9   DD UNIT=VIO,SPACE=(CYL,(5,5)),BLKSIZE=80,LRECL=80,RECFM=FB
          //SYSUT10  DD UNIT=VIO,SPACE=(CYL,(5,5)),BLKSIZE=80,LRECL=80,RECFM=FB
          //SYSUT11  DD UNIT=VIO,SPACE=(CYL,(5,5)),BLKSIZE=80,LRECL=80,RECFM=FB
          //SYSUT12  DD UNIT=VIO,SPACE=(CYL,(5,5)),BLKSIZE=80,LRECL=80,RECFM=FB
          //SYSUT13  DD UNIT=VIO,SPACE=(CYL,(5,5)),BLKSIZE=80,LRECL=80,RECFM=FB
          //SYSUT14  DD UNIT=VIO,SPACE=(CYL,(5,5)),BLKSIZE=80,LRECL=80,RECFM=FB
          //SYSUT15  DD UNIT=VIO,SPACE=(CYL,(5,5)),BLKSIZE=80,LRECL=80,RECFM=FB
          //SYSUT16  DD UNIT=VIO,SPACE=(CYL,(5,5)),BLKSIZE=80,LRECL=80,RECFM=FB
          //SYSUT17  DD UNIT=VIO,SPACE=(CYL,(5,5)),BLKSIZE=80,LRECL=80,RECFM=FB
          //SYSLIB   DD DSN=${HLQ}.COPY,DISP=SHR
          //         DD DSN=${HLQ}.BMS.COPY,DISP=SHR
          ${syslibCICS}
          ${syslibMQ}
          ${sysadata}
          ${sysxmlsd}
        logs:
          - log: ${LOGS}/${STEP}-${FILE_NAME}.log
            ddname: "*"

      # Link-Edit step
      - step: linkEdit
        type: mvs
        pgm: IEWBLINK
        parm: ${linkEditParms}
        condition: ${doLinkEdit}
        maxRC: 0
        dds:
          - { name: "SYSLIN", dsn: "${HLQ}.OBJ(${ENTRY})", options: "shr" }
          - { name: "SYSLMOD", dsn: "${HLQ}.LOAD(${ENTRY})", options: "shr", output: true, deployType: "${deployType}", scan: "${scanLoadModule}" }
          - { name: "SYSPRINT", log: "${STEP}-${FILE_NAME}.log", logEncoding: "${LOG_ENCODING}", options: "cyl space(5,5) unit(vio) blksize(133) lrecl(133) recfm(f,b) new" }
          - { name: "SYSUT1", options: "cyl space(5,5) unit(vio) blksize(80) lrecl(80) recfm(f,b) new" }
          - { name: "RESLIB", condition: { exists: RESLIB }, options: "shr" }
          - { name: "SYSLIB", dsn: "${HLQ}.OBJ", options: "shr" }
          - {                 dsn: "${SCEELKED}", options: "shr" }
          - {                 dsn: "${SDFHLOAD}", condition: "${IS_CICS}", options: "shr" }
          - {                 dsn: "${SDSNLOAD}", condition: "${IS_SQL}", options: "shr" }